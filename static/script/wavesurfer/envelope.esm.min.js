class t{constructor(){this.listeners={}}on(t,e){return this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),()=>this.un(t,e)}once(t,e){const i=this.on(t,e),s=this.on(t,()=>{i(),s()});return i}un(t,e){this.listeners[t]&&(e?this.listeners[t].delete(e):delete this.listeners[t])}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach(t=>t(...e))}}class e extends t{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t())}}const i={fadeInStart:0,fadeOutEnd:0,fadeInEnd:0,fadeOutStart:0,lineWidth:4,lineColor:"rgba(0, 0, 255, 0.5)",dragPointSize:10,dragPointFill:"rgba(255, 255, 255, 0.8)",dragPointStroke:"rgba(255, 255, 255, 0.8)"};class n extends t{constructor(i,s){super(),this.top=0,this.padding=i.dragPointSize/2+1;const n=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=(n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("viewBox","0 0 0 0"),n.setAttribute("preserveAspectRatio","none"),n.setAttribute("style","position: absolute; left: 0; top: 0; z-index: 4; pointer-events: none;"),n.setAttribute("part","envelope"),this.svg=n,document.createElementNS("http://www.w3.org/2000/svg","polyline"));o.setAttribute("points","0,0 0,0 0,0 0,0"),o.setAttribute("stroke",i.lineColor),o.setAttribute("stroke-width",i.lineWidth),o.setAttribute("fill","none"),o.setAttribute("style","pointer-events: none;"),o.setAttribute("part","polyline"),n.appendChild(o);var t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("stroke","transparent"),t.setAttribute("stroke-width",(3*i.lineWidth).toString()),t.setAttribute("style","cursor: ns-resize; pointer-events: all;"),t.setAttribute("part","line"),n.appendChild(t),[0,1].forEach(()=>{var t=document.createElementNS("http://www.w3.org/2000/svg","circle");t.setAttribute("r",(i.dragPointSize/2).toString()),t.setAttribute("fill",i.dragPointFill),t.setAttribute("stroke",i.dragPointStroke||i.dragPointFill),t.setAttribute("stroke-width","2"),t.setAttribute("style","cursor: ew-resize; pointer-events: all;"),t.setAttribute("part","circle"),n.appendChild(t)}),s.appendChild(n);{const i=t=>{var t=this.top+t,e=n.viewBox.baseVal["height"];t<-.5||e<t||(t=Math.min(1,Math.max(0,(e-t)/e)),this.emit("line-move",t))},s=(t,e)=>{var e=o.points.getItem(t).x+e,i=n.viewBox.baseVal["width"];this.emit("point-move",t,e/i)};this.makeDraggable(t,(t,e)=>i(e));t=this.svg.querySelectorAll("circle");Array.from(t).forEach((t,e)=>{this.makeDraggable(t,t=>s(e+1,t))})}}makeDraggable(t,e){{var[h,l,d=5]=[t,e];let a=()=>{};h?h.addEventListener("pointerdown",t=>{if(2!==t.button){t.preventDefault(),t.stopPropagation();let s=t.clientX,n=t.clientY,o=!1;const e=t=>{t.preventDefault(),t.stopPropagation();var e=t.clientX,i=t.clientY;if(o||Math.abs(e-s)>=d||Math.abs(i-n)>=d){const{left:t,top:d}=h.getBoundingClientRect();o||(o=!0),l(e-s,i-n,e-t,i-d),s=e,n=i}},i=t=>{o&&(t.preventDefault(),t.stopPropagation())},r=()=>{o,a()};document.addEventListener("pointermove",e),document.addEventListener("pointerup",r),document.addEventListener("pointerleave",r),document.addEventListener("click",i,!0),a=()=>{document.removeEventListener("pointermove",e),document.removeEventListener("pointerup",r),document.removeEventListener("pointerleave",r),setTimeout(()=>{document.removeEventListener("click",i,!0)},10)}}}):a}}update({x1:t,x2:e,x3:i,x4:s,y:n}){var o=this.svg.clientWidth,r=this.svg.clientHeight,n=(this.top=r-n*r,Math.max(this.padding,Math.min(this.top,r-this.padding)));this.svg.setAttribute("viewBox",`0 0 ${o} `+r);const a=this.svg.querySelector("polyline"),h=a["points"];h.getItem(0).x=t*o,h.getItem(0).y=r,h.getItem(1).x=e*o,h.getItem(1).y=n,h.getItem(2).x=i*o,h.getItem(2).y=n,h.getItem(3).x=s*o,h.getItem(3).y=r;t=this.svg.querySelector("line"),t.setAttribute("x1",h.getItem(1).x.toString()),t.setAttribute("x2",h.getItem(2).x.toString()),t.setAttribute("y1",n.toString()),t.setAttribute("y2",n.toString()),e=this.svg.querySelectorAll("circle");Array.from(e).forEach((t,e)=>{e=h.getItem(e+1);t.setAttribute("cx",e.x.toString()),t.setAttribute("cy",e.y.toString())})}destroy(){this.svg.remove()}}class s extends e{constructor(t){super(t),this.polyline=null,this.audioContext=null,this.gainNode=null,this.volume=1,this.isFadingIn=!1,this.isFadingOut=!1,this.naturalVolumeExponent=1.5,this.options=Object.assign({},i,t),this.options.lineColor=this.options.lineColor||i.lineColor,this.options.dragPointFill=this.options.dragPointFill||i.dragPointFill,this.options.dragPointStroke=this.options.dragPointStroke||i.dragPointStroke,this.volume=null!=(t=this.options.volume)?t:1}static create(t){return new s(t)}destroy(){var t;null!=(t=this.polyline)&&t.destroy(),super.destroy()}onInit(){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.initWebAudio(),this.initSvg(),this.initFadeEffects();const t=this.wavesurfer.getMediaElement(),e=()=>this.setVolume(t.volume);t.addEventListener("volumechange",e),this.subscriptions.push(()=>t.removeEventListener("volumechange",e),this.wavesurfer.on("redraw",()=>{var t=null==(t=this.wavesurfer)?void 0:t.getDuration();t&&(this.options.fadeInStart=this.options.fadeInStart||0,this.options.fadeOutEnd=this.options.fadeOutEnd||t,this.options.fadeInEnd=this.options.fadeInEnd||this.options.fadeInStart,this.options.fadeOutStart=this.options.fadeOutStart||this.options.fadeOutEnd,this.renderPolyline())}))}initSvg(){var t;this.wavesurfer&&(t=this.wavesurfer.getWrapper(),this.polyline=new n(this.options,t),this.subscriptions.push(this.polyline.on("line-move",t=>{this.setVolume(this.naturalVolume(t))}),this.polyline.on("point-move",(t,e)=>{e*=(null==(e=this.wavesurfer)?void 0:e.getDuration())||0;if(1===t){if(e<this.options.fadeInStart||e>this.options.fadeOutStart)return;this.options.fadeInEnd=e,this.emit("fade-in-change",e)}else if(2===t){if(e>this.options.fadeOutEnd||e<this.options.fadeInEnd)return;this.options.fadeOutStart=e,this.emit("fade-out-change",e)}this.renderPolyline()})))}renderPolyline(){var t;this.polyline&&this.wavesurfer&&(t=this.wavesurfer.getDuration())&&this.polyline.update({x1:this.options.fadeInStart/t,x2:this.options.fadeInEnd/t,x3:this.options.fadeOutStart/t,x4:this.options.fadeOutEnd/t,y:this.invertNaturalVolume(this.volume)})}initWebAudio(){var t=null==(t=this.wavesurfer)?void 0:t.getMediaElement();if(!t)return null;this.volume=null!=(e=this.options.volume)?e:t.volume;var e=new window.AudioContext;this.gainNode=e.createGain(),this.setGainValue(),e.createMediaElementSource(t).connect(this.gainNode),this.gainNode.connect(e.destination),this.audioContext=e}invertNaturalVolume(t){return Math.pow((t-1e-4)/.9999,1/this.naturalVolumeExponent)}naturalVolume(t){return 1e-4+.9999*Math.pow(t,this.naturalVolumeExponent)}setGainValue(){this.gainNode&&(this.gainNode.gain.value=this.volume)}initFadeEffects(){var t;this.audioContext&&this.wavesurfer&&(t=this.wavesurfer.on("timeupdate",e=>{var t;if(this.audioContext&&this.gainNode&&null!=(t=this.wavesurfer)&&t.isPlaying())if("suspended"===this.audioContext.state&&this.audioContext.resume(),!this.isFadingIn&&e>=this.options.fadeInStart&&e<=this.options.fadeInEnd)this.isFadingIn=!0,this.gainNode.gain.setValueAtTime(0,this.audioContext.currentTime),this.gainNode.gain.linearRampToValueAtTime(this.volume,this.audioContext.currentTime+(this.options.fadeInEnd-e));else if(!this.isFadingOut&&e>=this.options.fadeOutStart&&e<=this.options.fadeOutEnd)this.isFadingOut=!0,this.gainNode.gain.setValueAtTime(this.volume,this.audioContext.currentTime),this.gainNode.gain.linearRampToValueAtTime(0,this.audioContext.currentTime+(this.options.fadeOutEnd-e));else{let t=!1;this.isFadingIn&&(e<this.options.fadeInStart||e>this.options.fadeInEnd)&&(this.isFadingIn=!1,t=!0),this.isFadingOut&&(e<this.options.fadeOutStart||e>=this.options.fadeOutEnd)&&(this.isFadingOut=!1,t=!0),t&&(this.gainNode.gain.cancelScheduledValues(this.audioContext.currentTime),this.setGainValue())}}),this.subscriptions.push(t))}getCurrentVolume(){return this.gainNode?this.gainNode.gain.value:this.volume}setStartTime(t,e=!1){if(e){const e=this.options.fadeInEnd-this.options.fadeInStart;this.options.fadeInEnd=t+e}this.options.fadeInStart=t,this.renderPolyline()}setEndTime(t,e=!1){if(e){const e=this.options.fadeOutEnd-this.options.fadeOutStart;this.options.fadeOutStart=t-e}this.options.fadeOutEnd=t,this.renderPolyline()}setFadeInEnd(t){this.options.fadeInEnd=t,this.renderPolyline()}setFadeOutStart(t){this.options.fadeOutStart=t,this.renderPolyline()}setVolume(t){this.volume=t,this.setGainValue(),this.renderPolyline(),this.emit("volume-change",t)}}export{s as default};