function t(t,o,a,h){return new(a=a||Promise)(function(i,e){function s(t){try{n(h.next(t))}catch(t){e(t)}}function r(t){try{n(h.throw(t))}catch(t){e(t)}}function n(t){var e;t.done?i(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(s,r)}n((h=h.apply(t,o||[])).next())})}const e={decode:function(i,s){return t(this,void 0,void 0,function*(){const t=new AudioContext({sampleRate:s}),e=t.decodeAudioData(i);return e.finally(()=>t.close()),e})},createBuffer:function(e,t){"number"==typeof e[0]&&(e=[e]);{var i=e;const n=i[0];if(n.some(t=>1<t||t<-1)){var s=n.length;let e=0;for(let t=0;t<s;t++){var r=Math.abs(n[t]);r>e&&(e=r)}for(const n of i)for(let t=0;t<s;t++)n[t]/=e}}return{duration:t,length:e[0].length,sampleRate:e[0].length/t,numberOfChannels:e.length,getChannelData:t=>null==e?void 0:e[t],copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}},i={fetchBlob:function(e,i){return t(this,void 0,void 0,function*(){return fetch(e,i).then(t=>t.blob())})}};class s{constructor(){this.listeners={}}on(t,e){return this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),()=>this.un(t,e)}once(t,e){const i=this.on(t,e),s=this.on(t,()=>{i(),s()});return i}un(t,e){this.listeners[t]&&(e?this.listeners[t].delete(e):delete this.listeners[t])}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach(t=>t(...e))}}class n extends s{constructor(t){super(),t.media?this.media=t.media:this.media=document.createElement("audio"),t.autoplay&&(this.media.autoplay=!0),null!=t.playbackRate&&(this.media.playbackRate=t.playbackRate)}onMediaEvent(t,e,i){return this.media.addEventListener(t,e,i),()=>this.media.removeEventListener(t,e)}onceMediaEvent(t,e){return this.onMediaEvent(t,e,{once:!0})}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){var t=this.getSrc();t.startsWith("blob:")&&URL.revokeObjectURL(t)}setSrc(t,e){this.getSrc()!==t&&(this.revokeSrc(),e=e instanceof Blob?URL.createObjectURL(e):t,this.media.src=e,this.media.load())}destroy(){this.media.pause(),this.revokeSrc(),this.media.src="",this.media.load()}play(){return this.media.play()}pause(){this.media.pause()}isPlaying(){return 0<this.media.currentTime&&!this.media.paused&&!this.media.ended}setTime(t){this.media.currentTime=t}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(t){this.media.volume=t}getMuted(){return this.media.muted}setMuted(t){this.media.muted=t}getPlaybackRate(){return this.media.playbackRate}setPlaybackRate(t,e){null!=e&&(this.media.preservesPitch=e),this.media.playbackRate=t}getMediaElement(){return this.media}setSinkId(t){return this.media.setSinkId(t)}}class r extends s{constructor(t){let e;if(super(),this.timeouts=[],this.isScrolling=!1,this.audioData=null,this.resizeObserver=null,this.isDragging=!1,"string"==typeof(this.options=t).container?e=document.querySelector(t.container):t.container instanceof HTMLElement&&(e=t.container),!e)throw new Error("Container not found");this.parent=e;var[t,i]=this.initHtml();e.appendChild(t),this.container=t,this.scrollContainer=i.querySelector(".scroll"),this.wrapper=i.querySelector(".wrapper"),this.canvasWrapper=i.querySelector(".canvases"),this.progressWrapper=i.querySelector(".progress"),this.cursor=i.querySelector(".cursor"),this.initEvents()}initEvents(){this.wrapper.addEventListener("click",t=>{var e=this.wrapper.getBoundingClientRect(),t=(t.clientX-e.left)/e.width;this.emit("click",t)}),this.initDrag(),this.scrollContainer.addEventListener("scroll",()=>{var{scrollLeft:t,scrollWidth:e,clientWidth:i}=this.scrollContainer;this.emit("scroll",t/e,(t+i)/e)});const t=this.createDelay(100);this.resizeObserver=new ResizeObserver(()=>{t(()=>this.reRender())}),this.resizeObserver.observe(this.scrollContainer)}initDrag(){{var[h,l,d,c,u=5]=[this.wrapper,(t,e,i)=>{this.emit("drag",Math.max(0,Math.min(1,i/this.wrapper.clientWidth)))},()=>this.isDragging=!0,()=>this.isDragging=!1];let a=()=>{};h?h.addEventListener("pointerdown",t=>{if(2!==t.button){t.preventDefault(),t.stopPropagation();let s=t.clientX,r=t.clientY,n=!1;const e=t=>{t.preventDefault(),t.stopPropagation();var e=t.clientX,i=t.clientY;if(n||Math.abs(e-s)>=u||Math.abs(i-r)>=u){const{left:t,top:u}=h.getBoundingClientRect();n||(n=!0,null==d)||d((s,t),(r,u)),l(s,r,e-t,u),s=e,r=i}},i=t=>{n&&(t.preventDefault(),t.stopPropagation())},o=()=>{n&&null!=c&&c(),a()};document.addEventListener("pointermove",e),document.addEventListener("pointerup",o),document.addEventListener("pointerleave",o),document.addEventListener("click",i,!0),a=()=>{document.removeEventListener("pointermove",e),document.removeEventListener("pointerup",o),document.removeEventListener("pointerleave",o),setTimeout(()=>{document.removeEventListener("click",i,!0)},10)}}}):a}}getHeight(){return null==this.options.height?128:isNaN(Number(this.options.height))?"auto"===this.options.height&&this.parent.clientHeight||128:Number(this.options.height)}initHtml(){var t=document.createElement("div"),e=t.attachShadow({mode:"open"});return e.innerHTML=`
      <style>
        :host {
          user-select: none;
        }
        :host .scroll {
          overflow-x: auto;
          overflow-y: hidden;
          width: 100%;
          position: relative;
          touch-action: none;
        }
        :host .noScrollbar {
          scrollbar-color: transparent;
          scrollbar-width: none;
        }
        :host .noScrollbar::-webkit-scrollbar {
          display: none;
          -webkit-appearance: none;
        }
        :host .wrapper {
          position: relative;
          overflow: visible;
          z-index: 2;
        }
        :host .canvases {
          min-height: ${this.getHeight()}px;
        }
        :host .canvases > div {
          position: relative;
        }
        :host canvas {
          display: block;
          position: absolute;
          top: 0;
          image-rendering: pixelated;
        }
        :host .progress {
          pointer-events: none;
          position: absolute;
          z-index: 2;
          top: 0;
          left: 0;
          width: 0;
          height: 100%;
          overflow: hidden;
        }
        :host .progress > div {
          position: relative;
        }
        :host .cursor {
          pointer-events: none;
          position: absolute;
          z-index: 5;
          top: 0;
          left: 0;
          height: 100%;
          border-radius: 2px;
        }
      </style>

      <div class="scroll" part="scroll">
        <div class="wrapper">
          <div class="canvases"></div>
          <div class="progress" part="progress"></div>
          <div class="cursor" part="cursor"></div>
        </div>
      </div>
    `,[t,e]}setOptions(t){this.options=t,this.reRender()}getWrapper(){return this.wrapper}getScroll(){return this.scrollContainer.scrollLeft}destroy(){var t;this.container.remove(),null!=(t=this.resizeObserver)&&t.disconnect()}createDelay(e=10){const i={};return this.timeouts.push(i),t=>{i.timeout&&clearTimeout(i.timeout),i.timeout=setTimeout(t,e)}}convertColorValues(t){if(!Array.isArray(t))return t||"";if(t.length<2)return t[0]||"";const e=document.createElement("canvas"),i=e.getContext("2d").createLinearGradient(0,0,0,e.height),s=1/(t.length-1);return t.forEach((t,e)=>{e*=s;i.addColorStop(e,t)}),i}renderBars(n,o,a){if(a.fillStyle=this.convertColorValues(o.waveColor),o.renderFunction)o.renderFunction(n,a);else{const d=n[0],c=n[1]||n[0],u=d.length,p=window.devicePixelRatio||1,{width:m,height:g}=a.canvas,v=g/2,t=o.barHeight||1,f=o.barWidth?o.barWidth*p:1,b=o.barGap?o.barGap*p:o.barWidth?f/2:0,y=o.barRadius||0,C=m/(f+b)/u;let e=1;if(o.normalize)for(let t=e=0;t<u;t++){const o=Math.abs(d[t]);o>e&&(e=o)}var h=v/e*t,l=y&&"roundRect"in a?"roundRect":"rect";a.beginPath();let i=0,s=0,r=0;for(let t=0;t<=u;t++){const u=Math.round(t*C);if(u>i){const n=Math.round(s*h),d=n+Math.round(r*h)||1;let t=v-n;"top"===o.barAlign?t=0:"bottom"===o.barAlign&&(t=g-d),a[l](i*(f+b),t,f,d,y),i=u,s=0,r=0}const p=Math.abs(d[t]||0),m=Math.abs(c[t]||0);p>s&&(s=p),m>r&&(r=m)}a.fill(),a.closePath()}}renderSingleCanvas(t,e,i,s,r,n,o,a){var h=window.devicePixelRatio||1,l=document.createElement("canvas"),d=t[0].length,s=(l.width=Math.round(i*(n-r)/d),l.height=s*h,l.style.width=Math.floor(l.width/h)+"px",l.style.height=s+"px",l.style.left=Math.floor(r*i/h/d)+"px",o.appendChild(l),l.getContext("2d")),i=(this.renderBars(t.map(t=>t.slice(r,n)),e,s),l.cloneNode()),h=(a.appendChild(i),i.getContext("2d"));0<l.width&&0<l.height&&h.drawImage(l,0,0),h.globalCompositeOperation="source-in",h.fillStyle=this.convertColorValues(e.progressColor),h.fillRect(0,0,l.width,l.height)}renderWaveform(i,s,n){const o=document.createElement("div"),a=this.getHeight(),h=(o.style.height=a+"px",this.canvasWrapper.style.minHeight=a+"px",this.canvasWrapper.appendChild(o),o.cloneNode()),{scrollLeft:t,scrollWidth:e,clientWidth:l}=(this.progressWrapper.appendChild(h),this.scrollContainer),d=i[0].length,c=d/e;let u=Math.min(r.MAX_CANVAS_WIDTH,l);if(s.barWidth||s.barGap){const i=s.barWidth||.5,n=i+(s.barGap||i/2);u%n!=0&&(u=Math.floor(u/n)*n)}const p=Math.floor(Math.abs(t)*c),m=Math.floor(p+u*c),g=m-p,v=(t,e)=>{this.renderSingleCanvas(i,s,n,a,Math.max(0,t),Math.min(e,d),o,h)},f=this.createDelay(),b=this.createDelay(),y=(t,e)=>{v(t,e),0<t&&f(()=>{y(t-g,e-g)})},C=(t,e)=>{v(t,e),e<d&&b(()=>{C(t+g,e+g)})};y(p,m),m<d&&C(m,m+g)}render(e){this.timeouts.forEach(t=>t.timeout&&clearTimeout(t.timeout)),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.wrapper.style.width="";const t=window.devicePixelRatio||1,i=this.scrollContainer.clientWidth,s=Math.ceil(e.duration*(this.options.minPxPerSec||0));this.isScrolling=s>i;var r=this.options.fillParent&&!this.isScrolling,n=(r?i:s)*t;if(this.wrapper.style.width=r?"100%":s+"px",this.scrollContainer.style.overflowX=this.isScrolling?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=""+(this.options.cursorColor||this.options.progressColor),this.cursor.style.width=this.options.cursorWidth+"px",this.options.splitChannels)for(let t=0;t<e.numberOfChannels;t++){const i=Object.assign(Object.assign({},this.options),this.options.splitChannels[t]);this.renderWaveform([e.getChannelData(t)],i,n)}else{const t=[e.getChannelData(0)];1<e.numberOfChannels&&t.push(e.getChannelData(1)),this.renderWaveform(t,this.options,n)}this.audioData=e,this.emit("render")}reRender(){var t,e;this.audioData&&(t=this.progressWrapper.clientWidth,this.render(this.audioData),e=this.progressWrapper.clientWidth,this.scrollContainer.scrollLeft+=e-t)}zoom(t){this.options.minPxPerSec=t,this.reRender()}scrollIntoView(t,e=!1){const{clientWidth:i,scrollLeft:s,scrollWidth:r}=this.scrollContainer,n=r*t,o=i/2;if(n>s+(e&&this.options.autoCenter&&!this.isDragging?o:i)||n<s)if(this.options.autoCenter&&!this.isDragging){const t=o/20;n-(s+o)>=t&&n<s+i?this.scrollContainer.scrollLeft+=t:this.scrollContainer.scrollLeft=n-o}else if(this.isDragging){const t=10;this.scrollContainer.scrollLeft=n<s?n-10:n-i+10}else this.scrollContainer.scrollLeft=n;{const t=this.scrollContainer["scrollLeft"],e=t/r,s=(t+i)/r;this.emit("scroll",e,s)}}renderProgress(t,e){isNaN(t)||(this.progressWrapper.style.width=100*t+"%",this.cursor.style.left=100*t+"%",this.cursor.style.marginLeft=100===Math.round(100*t)?`-${this.options.cursorWidth}px`:"",this.isScrolling&&this.options.autoScroll&&this.scrollIntoView(t,e))}}r.MAX_CANVAS_WIDTH=4e3;class o extends s{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}const a={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,autoScroll:!0,autoCenter:!0,sampleRate:8e3};class h extends n{static create(t){return new h(t)}constructor(t){super({media:t.media,autoplay:t.autoplay,playbackRate:t.audioRate}),this.plugins=[],this.decodedData=null,this.duration=null,this.subscriptions=[],this.options=Object.assign({},a,t),this.timer=new o,this.renderer=new r(this.options),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initPlugins();t=this.options.url||(null==(t=this.options.media)?void 0:t.currentSrc)||(null==(t=this.options.media)?void 0:t.src);t&&this.load(t,this.options.peaks,this.options.duration)}setOptions(t){this.options=Object.assign({},this.options,t),this.renderer.setOptions(this.options),t.audioRate&&this.setPlaybackRate(t.audioRate)}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",()=>{var t=this.getCurrentTime();this.renderer.renderProgress(t/this.getDuration(),!0),this.emit("timeupdate",t),this.emit("audioprocess",t)}))}initPlayerEvents(){this.subscriptions.push(this.onMediaEvent("timeupdate",()=>{var t=this.getCurrentTime();this.renderer.renderProgress(t/this.getDuration(),this.isPlaying()),this.emit("timeupdate",t)}),this.onMediaEvent("play",()=>{this.emit("play"),this.timer.start()}),this.onMediaEvent("pause",()=>{this.emit("pause"),this.timer.stop()}),this.onMediaEvent("ended",()=>{this.emit("finish")}),this.onMediaEvent("seeking",()=>{this.emit("seeking",this.getCurrentTime())}))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",t=>{this.options.interact&&(this.seekTo(t),this.emit("interaction",this.getCurrentTime()),this.emit("click",t))}),this.renderer.on("scroll",(t,e)=>{var i=this.getDuration();this.emit("scroll",t*i,e*i)}),this.renderer.on("render",()=>{this.emit("redraw")}));{let e;this.subscriptions.push(this.renderer.on("drag",t=>{this.options.interact&&(this.renderer.renderProgress(t),clearTimeout(e),e=setTimeout(()=>{this.seekTo(t)},this.isPlaying()?0:200),this.emit("interaction",t*this.getDuration()),this.emit("drag",t))}))}}initPlugins(){var t;null!=(t=this.options.plugins)&&t.length&&this.options.plugins.forEach(t=>{this.registerPlugin(t)})}registerPlugin(e){return e.init(this),this.plugins.push(e),this.subscriptions.push(e.once("destroy",()=>{this.plugins=this.plugins.filter(t=>t!==e)})),e}getWrapper(){return this.renderer.getWrapper()}getScroll(){return this.renderer.getScroll()}getActivePlugins(){return this.plugins}load(s,r,n){return t(this,void 0,void 0,function*(){this.isPlaying()&&this.pause(),this.decodedData=null,this.duration=null,this.emit("load",s);var t=r?void 0:yield i.fetchBlob(s,this.options.fetchParams);if(this.setSrc(s,t),this.duration=n||this.getDuration()||(yield new Promise(t=>{this.onceMediaEvent("loadedmetadata",()=>t(this.getDuration()))}))||0,r)this.decodedData=e.createBuffer(r,this.duration);else if(t){const i=yield t.arrayBuffer();this.decodedData=yield e.decode(i,this.options.sampleRate),0!==this.duration&&this.duration!==1/0||(this.duration=this.decodedData.duration)}this.emit("decode",this.duration),this.decodedData&&this.renderer.render(this.decodedData),this.emit("ready",this.duration)})}zoom(t){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(t),this.emit("zoom",t)}getDecodedData(){return this.decodedData}getDuration(){return null!==this.duration?this.duration:super.getDuration()}toggleInteraction(t){this.options.interact=t}seekTo(t){t=this.getDuration()*t;this.setTime(t)}playPause(){return t(this,void 0,void 0,function*(){return this.isPlaying()?this.pause():this.play()})}stop(){this.pause(),this.setTime(0)}skip(t){this.setTime(this.getCurrentTime()+t)}empty(){this.load("",[[0]],.001)}destroy(){this.emit("destroy"),this.plugins.forEach(t=>t.destroy()),this.subscriptions.forEach(t=>t()),this.timer.destroy(),this.renderer.destroy(),super.destroy()}}export{h as default};