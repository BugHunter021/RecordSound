class t{constructor(){this.listeners={}}on(t,e){return this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),()=>this.un(t,e)}once(t,e){const i=this.on(t,e),n=this.on(t,()=>{i(),n()});return i}un(t,e){this.listeners[t]&&(e?this.listeners[t].delete(e):delete this.listeners[t])}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach(t=>t(...e))}}class e extends t{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t())}}function i(a,l,h,d,u=5){let c=()=>{};if(!a)return c;const t=t=>{if(2!==t.button){t.preventDefault(),t.stopPropagation();let n=t.clientX,s=t.clientY,r=!1;const e=t=>{t.preventDefault(),t.stopPropagation();var e=t.clientX,i=t.clientY;if(r||Math.abs(e-n)>=u||Math.abs(i-s)>=u){const{left:t,top:u}=a.getBoundingClientRect();r||(r=!0,null==h)||h(n-t,s-u),l(e-n,i-s,e-t,i-u),n=e,s=i}},i=t=>{r&&(t.preventDefault(),t.stopPropagation())},o=()=>{r&&null!=d&&d(),c()};document.addEventListener("pointermove",e),document.addEventListener("pointerup",o),document.addEventListener("pointerleave",o),document.addEventListener("click",i,!0),c=()=>{document.removeEventListener("pointermove",e),document.removeEventListener("pointerup",o),document.removeEventListener("pointerleave",o),setTimeout(()=>{document.removeEventListener("click",i,!0)},10)}}};return a.addEventListener("pointerdown",t),()=>{c(),a.removeEventListener("pointerdown",t)}}class n extends t{constructor(t,e){super(),this.totalDuration=e,this.minLength=0,this.maxLength=1/0,this.id=t.id||"region-"+Math.random().toString(32).slice(2),this.start=t.start,this.end=null!=(e=t.end)?e:t.start,this.drag=null==(e=t.drag)||e,this.resize=null==(e=t.resize)||e,this.color=null!=(e=t.color)?e:"rgba(0, 0, 0, 0.1)",this.minLength=null!=(e=t.minLength)?e:this.minLength,this.maxLength=null!=(e=t.maxLength)?e:this.maxLength,this.element=this.initElement(t.content),this.renderPosition(),this.initMouseEvents()}initElement(t){const e=document.createElement("div"),i=this.start===this.end;if(e.setAttribute("part",`${i?"marker":"region"} `+this.id),e.setAttribute("style",`
      position: absolute;
      height: 100%;
      background-color: ${i?"none":this.color};
      border-left: ${i?"2px solid "+this.color:"none"};
      border-radius: 2px;
      box-sizing: border-box;
      transition: background-color 0.2s ease;
      cursor: ${this.drag?"grab":"default"};
      pointer-events: all;
    `),t&&("string"==typeof t?(this.content=document.createElement("div"),this.content.style.padding=`0.2em ${i?.2:.4}em`,this.content.textContent=t):this.content=t,this.content.setAttribute("part","region-content"),e.appendChild(this.content)),!i){const t=document.createElement("div"),i=(t.setAttribute("data-resize","left"),t.setAttribute("style",`
        position: absolute;
        z-index: 2;
        width: 6px;
        height: 100%;
        top: 0;
        left: 0;
        border-left: 2px solid rgba(0, 0, 0, 0.5);
        border-radius: 2px 0 0 2px;
        cursor: ${this.resize?"ew-resize":"default"};
        word-break: keep-all;
      `),t.setAttribute("part","region-handle region-handle-left"),t.cloneNode());i.setAttribute("data-resize","right"),i.style.left="",i.style.right="0",i.style.borderRight=i.style.borderLeft,i.style.borderLeft="",i.style.borderRadius="0 2px 2px 0",i.setAttribute("part","region-handle region-handle-right"),e.appendChild(t),e.appendChild(i)}return e}renderPosition(){var t=this.start/this.totalDuration,e=(this.totalDuration-this.end)/this.totalDuration;this.element.style.left=100*t+"%",this.element.style.right=100*e+"%"}initMouseEvents(){var t=this["element"];t&&(t.addEventListener("click",t=>this.emit("click",t)),t.addEventListener("mouseenter",t=>this.emit("over",t)),t.addEventListener("mouseleave",t=>this.emit("leave",t)),t.addEventListener("dblclick",t=>this.emit("dblclick",t)),i(t,t=>this.onMove(t),()=>this.onStartMoving(),()=>this.onEndMoving()),i(t.querySelector('[data-resize="left"]'),t=>this.onResize(t,"start"),()=>null,()=>this.onEndResizing(),1),i(t.querySelector('[data-resize="right"]'),t=>this.onResize(t,"end"),()=>null,()=>this.onEndResizing(),1))}onStartMoving(){this.drag&&(this.element.style.cursor="grabbing")}onEndMoving(){this.drag&&(this.element.style.cursor="grab",this.emit("update-end"))}_onUpdate(t,e){var i;this.element.parentElement&&(t=t/this.element.parentElement.clientWidth*this.totalDuration,i=e&&"start"!==e?this.start:this.start+t,t=(e=e&&"end"!==e?this.end:this.end+t)-i,0<=i)&&e<=this.totalDuration&&i<=e&&t>=this.minLength&&t<=this.maxLength&&(this.start=i,this.end=e,this.renderPosition(),this.emit("update"))}onMove(t){this.drag&&this._onUpdate(t)}onResize(t,e){this.resize&&this._onUpdate(t,e)}onEndResizing(){this.resize&&this.emit("update-end")}_setTotalDuration(t){this.totalDuration=t,this.renderPosition()}play(){this.emit("play")}setOptions(t){var e;t.color&&(this.color=t.color,this.element.style.backgroundColor=this.color),void 0!==t.drag&&(this.drag=t.drag,this.element.style.cursor=this.drag?"grab":"default"),void 0!==t.resize&&(this.resize=t.resize,this.element.querySelectorAll("[data-resize]").forEach(t=>{t.style.cursor=this.resize?"ew-resize":"default"})),void 0===t.start&&void 0===t.end||(this.start=null!=(e=t.start)?e:this.start,this.end=null!=(e=t.end)?e:this.end,this.renderPosition())}remove(){this.emit("remove"),this.element.remove(),this.element=null}}class s extends e{constructor(t){super(t),this.regions=[],this.regionsContainer=this.initRegionsContainer()}static create(t){return new s(t)}onInit(){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");this.wavesurfer.getWrapper().appendChild(this.regionsContainer);let i=null;this.subscriptions.push(this.wavesurfer.on("timeupdate",e=>{var t=this.regions.find(t=>t.start<=e&&t.end>=e);i&&i!==t&&(this.emit("region-out",i),i=null),t&&t!==i&&(i=t,this.emit("region-in",t))}))}initRegionsContainer(){var t=document.createElement("div");return t.setAttribute("style","\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      z-index: 3;\n      pointer-events: none;\n    "),t}getRegions(){return this.regions}avoidOverlapping(i){if(i.content){const t=i.content,n=t.getBoundingClientRect().left,s=i.element.scrollWidth,e=this.regions.filter(t=>{var e;return!(t===i||!t.content)&&(e=t.content.getBoundingClientRect().left,t=t.element.scrollWidth,n<e+t)&&e<n+s}).map(t=>{return(null==(t=t.content)?void 0:t.getBoundingClientRect().height)||0}).reduce((t,e)=>t+e,0);t.style.marginTop=e+"px"}}saveRegion(e){this.regionsContainer.appendChild(e.element),this.avoidOverlapping(e),this.regions.push(e),this.emit("region-created",e);const t=[e.on("update-end",()=>{this.avoidOverlapping(e),this.emit("region-updated",e)}),e.on("play",()=>{var t;null!=(t=this.wavesurfer)&&t.play(),null!=(t=this.wavesurfer)&&t.setTime(e.start)}),e.on("click",t=>{this.emit("region-clicked",e,t)}),e.on("dblclick",t=>{this.emit("region-double-clicked",e,t)}),e.once("remove",()=>{t.forEach(t=>t()),this.regions=this.regions.filter(t=>t!==e)})];this.subscriptions.push(...t)}addRegion(t){if(!this.wavesurfer)throw Error("WaveSurfer is not initialized");const e=this.wavesurfer.getDuration(),i=new n(t,e);return e?this.saveRegion(i):this.subscriptions.push(this.wavesurfer.once("ready",t=>{i._setTotalDuration(t),this.saveRegion(i)})),i}enableDragSelection(r){var t=null==(t=null==(t=this.wavesurfer)?void 0:t.getWrapper())?void 0:t.querySelector("div");if(!t)return()=>{};let o=null,a=0;return i(t,(t,e,i)=>{o&&o._onUpdate(t,i>a?"end":"start")},t=>{var e,i,s;a=t,this.wavesurfer&&(e=this.wavesurfer.getDuration(),s=t/(i=this.wavesurfer.getWrapper().clientWidth)*e,t=(t+5)/i*e,o=new n(Object.assign(Object.assign({},r),{start:s,end:t}),e),this.regionsContainer.appendChild(o.element))},()=>{o&&(this.saveRegion(o),o=null)})}clearRegions(){this.regions.forEach(t=>t.remove())}destroy(){this.clearRegions(),super.destroy()}}export{s as default};