class t{constructor(){this.listeners={}}on(t,e){return this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),()=>this.un(t,e)}once(t,e){const s=this.on(t,e),i=this.on(t,()=>{s(),i()});return s}un(t,e){this.listeners[t]&&(e?this.listeners[t].delete(e):delete this.listeners[t])}unAll(){this.listeners={}}emit(t,...e){this.listeners[t]&&this.listeners[t].forEach(t=>t(...e))}}class e extends t{constructor(t){super(),this.subscriptions=[],this.options=t}onInit(){}init(t){this.wavesurfer=t,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach(t=>t())}}function s(t,e,s,i){switch(this.bufferSize=t,this.sampleRate=e,this.bandwidth=2/t*(e/2),this.sinTable=new Float32Array(t),this.cosTable=new Float32Array(t),this.windowValues=new Float32Array(t),this.reverseTable=new Uint32Array(t),this.peakBand=0,this.peak=0,s){case"bartlett":for(a=0;a<t;a++)this.windowValues[a]=2/(t-1)*((t-1)/2-Math.abs(a-(t-1)/2));break;case"bartlettHann":for(a=0;a<t;a++)this.windowValues[a]=.62-.48*Math.abs(a/(t-1)-.5)-.38*Math.cos(2*Math.PI*a/(t-1));break;case"blackman":for(i=i||.16,a=0;a<t;a++)this.windowValues[a]=(1-i)/2-.5*Math.cos(2*Math.PI*a/(t-1))+i/2*Math.cos(4*Math.PI*a/(t-1));break;case"cosine":for(a=0;a<t;a++)this.windowValues[a]=Math.cos(Math.PI*a/(t-1)-Math.PI/2);break;case"gauss":for(i=i||.25,a=0;a<t;a++)this.windowValues[a]=Math.pow(Math.E,-.5*Math.pow((a-(t-1)/2)/(i*(t-1)/2),2));break;case"hamming":for(a=0;a<t;a++)this.windowValues[a]=.54-.46*Math.cos(2*Math.PI*a/(t-1));break;case"hann":case void 0:for(a=0;a<t;a++)this.windowValues[a]=.5*(1-Math.cos(2*Math.PI*a/(t-1)));break;case"lanczoz":for(a=0;a<t;a++)this.windowValues[a]=Math.sin(Math.PI*(2*a/(t-1)-1))/(Math.PI*(2*a/(t-1)-1));break;case"rectangular":for(a=0;a<t;a++)this.windowValues[a]=1;break;case"triangular":for(a=0;a<t;a++)this.windowValues[a]=2/t*(t/2-Math.abs(a-(t-1)/2));break;default:throw Error("No such window function '"+s+"'")}for(var a,r=1,h=t>>1;r<t;){for(a=0;a<r;a++)this.reverseTable[a+r]=this.reverseTable[a]+h;r<<=1,h>>=1}for(a=0;a<t;a++)this.sinTable[a]=Math.sin(-Math.PI/a),this.cosTable[a]=Math.cos(-Math.PI/a);this.calculateSpectrum=function(t){var e,s=this.bufferSize,i=this.cosTable,a=this.sinTable,r=this.reverseTable,h=new Float32Array(s),n=new Float32Array(s),l=2/this.bufferSize,o=Math.sqrt,c=new Float32Array(s/2),f=Math.floor(Math.log(s)/Math.LN2);if(Math.pow(2,f)!==s)throw"Invalid buffer size, must be a power of 2.";if(s!==t.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+s+" Buffer Size: "+t.length;for(var p,u,d,w,M=1,b=0;b<s;b++)h[b]=t[r[b]]*this.windowValues[r[b]],n[b]=0;for(;M<s;){for(var g=i[M],m=a[M],v=1,y=0,x=0;x<M;x++){for(b=x;b<s;)u=v*h[p=b+M]-y*n[p],d=v*n[p]+y*h[p],h[p]=h[b]-u,n[p]=n[b]-d,h[b]+=u,n[b]+=d,b+=M<<1;v=(w=v)*g-y*m,y=w*m+y*g}M<<=1}for(var b=0,k=s/2;b<k;b++)(e=l*o((e=h[b])*e+(e=n[b])*e))>this.peak&&(this.peakBand=b,this.peak=e),c[b]=e;return c}}class i extends e{static create(t){return new i(t||{})}constructor(e){if(super(e),this.utils={style:(t,e)=>Object.assign(t.style,e)},this.drawSpectrogram=t=>{isNaN(t[0][0])||(t=[t]);const s=this.spectrCc,i=this.height,a=this.width,r=this.buffer.sampleRate/2,h=this.frequencyMin,n=this.frequencyMax;if(s){for(let e=0;e<t.length;e++){var l=this.resample(t[e]),o=new ImageData(a,i);for(let e=0;e<l.length;e++)for(let t=0;t<l[e].length;t++){const r=this.colorMap[l[e][t]],h=4*((i-t)*a+e);o.data[h]=255*r[0],o.data[1+h]=255*r[1],o.data[2+h]=255*r[2],o.data[3+h]=255*r[3]}createImageBitmap(o).then(t=>{s.drawImage(t,0,i*(1-n/r),a,i*(n-h)/r,0,i*e,a,i)})}this.emit("ready")}},this.frequenciesDataUrl=e.frequenciesDataUrl,this.container="string"==typeof e.container?document.querySelector(e.container):e.container,e.colorMap){if(e.colorMap.length<256)throw new Error("Colormap must contain 256 elements");for(let t=0;t<e.colorMap.length;t++)if(4!==e.colorMap[t].length)throw new Error("ColorMap entries must contain 4 values");this.colorMap=e.colorMap}else{this.colorMap=[];for(let t=0;t<256;t++){var s=(255-t)/256;this.colorMap.push([s,s,s,1])}}this.fftSamples=e.fftSamples||512,this.height=e.height||this.fftSamples/2,this.noverlap=e.noverlap,this.windowFunc=e.windowFunc,this.alpha=e.alpha,this.channels=1,this.frequencyMin=e.frequencyMin||0,this.frequencyMax=e.frequencyMax||0,this.createWrapper(),this.createCanvas()}onInit(){this.container=this.container||this.wavesurfer.getWrapper(),this.container.appendChild(this.wrapper),this.wavesurfer.options.fillParent&&this.utils.style(this.wrapper,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.width=this.wavesurfer.getWrapper().offsetWidth,this.subscriptions.push(this.wavesurfer.on("redraw",()=>this.render()))}destroy(){this.unAll(),this.wavesurfer.un("ready",this._onReady),this.wavesurfer.un("redraw",this._onRender),this.wavesurfer=null,this.util=null,this.options=null,this.wrapper&&(this.wrapper.remove(),this.wrapper=null),super.destroy()}createWrapper(){var t;this.wrapper=document.createElement("div"),this.utils.style(this.wrapper,{display:"block",position:"relative",userSelect:"none",webkitUserSelect:"none",height:this.height*this.channels+"px"}),this.options.labels&&((t=document.createElement("canvas")).setAttribute("part","spec-labels"),t.classList.add("spec-labels"),this.utils.style(t,{position:"absolute",zIndex:9,width:"55px",height:"100%"}),this.wrapper.appendChild(t),this.labelsEl=t),this.wrapper.addEventListener("click",this._onWrapperClick)}_wrapperClickHandler(t){t.preventDefault();t="offsetX"in t?t.offsetX:t.layerX;this.emit("click",t/this.width||0)}createCanvas(){var t=document.createElement("canvas");this.wrapper.appendChild(t),this.spectrCc=t.getContext("2d"),this.utils.style(t,{position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:4}),this.canvas=t}render(){this.canvas.width=this.width,this.canvas.height=this.height,this.frequenciesDataUrl?this.loadFrequenciesData(this.frequenciesDataUrl):this.getFrequencies(this.drawSpectrogram),this.loadLabels(this.options.labelsBackground,"12px","12px","",this.options.labelsColor,this.options.labelsHzColor||this.options.labelsColor,"center","#specLabels")}getFrequencies(a){const r=this.fftSamples,h=this.wavesurfer.getDecodedData(),n=this.channels;if(this.frequencyMax=this.frequencyMax||h.sampleRate/2,h){const t=(this.buffer=h).sampleRate,o=[];let i=this.noverlap;if(!i){const a=h.length/this.canvas.width;i=Math.max(0,Math.round(r-a))}var l=new s(r,t,this.windowFunc,this.alpha);for(let t=0;t<n;t++){const s=h.getChannelData(t),n=[];let e=0;for(;e+r<s.length;){const a=s.slice(e,e+r),h=l.calculateSpectrum(a),o=new Uint8Array(r/2);let t;for(t=0;t<r/2;t++)o[t]=Math.max(-255,45*Math.log10(h[t]));n.push(o),e+=r-i}o.push(n)}a(o,this)}}loadFrequenciesData(t){return fetch(t).then(t=>t.json()).then(this.drawSpectrogram)}freqType(t){return 1e3<=t?(t/1e3).toFixed(1):Math.round(t)}unitType(t){return 1e3<=t?"KHz":"Hz"}loadLabels(s,i,a,r,h,n,l,t){s=s||"rgba(68,68,68,0)",i=i||"12px",a=a||"12px",r=r||"Helvetica",h=h||"#fff",n=n||"#fff",l=l||"center";const o=this.height||512,c=o/256*5,f=this.frequencyMin,p=(this.frequencyMax-f)/c,u=this.labelsEl.getContext("2d"),e=window.devicePixelRatio;if(this.labelsEl.height=this.height*this.channels*e,this.labelsEl.width=55*e,u.scale(e,e),u)for(let e=0;e<this.channels;e++){let t;for(u.fillStyle=s,u.fillRect(0,e*o,55,(1+e)*o),u.fill(),t=0;t<=c;t++){u.textAlign=l,u.textBaseline="middle";const s=f+p*t,c=this.freqType(s),w=this.unitType(s);var d=0==t?(1+e)*o+t-10:(1+e)*o-50*t+2;u.fillStyle=n,u.font=a+" "+r,u.fillText(w,40,d),u.fillStyle=h,u.font=i+" "+r,u.fillText(c,16,d)}}}resample(s){const i=this.width,a=[],r=1/s.length,h=1/i;let n;for(n=0;n<i;n++){const i=new Array(s[0].length);let e;for(e=0;e<s.length;e++){const a=e*r,o=a+r,c=n*h,f=c+h,p=o<=c||f<=a?0:Math.min(Math.max(o,c),Math.max(f,a))-Math.max(Math.min(o,c),Math.min(f,a));let t;if(0<p)for(t=0;t<s[0].length;t++)null==i[t]&&(i[t]=0),i[t]+=p/h*s[e][t]}var l=new Uint8Array(s[0].length);let t;for(t=0;t<s[0].length;t++)l[t]=i[t];a.push(l)}return a}}export{i as default};