import{makeDraggable}from"./draggable.js";import EventEmitter from"./event-emitter.js";class Renderer extends EventEmitter{constructor(t){super(),this.timeouts=[],this.isScrolling=!1,this.audioData=null,this.resizeObserver=null,this.isDragging=!1;let e;if("string"==typeof(this.options=t).container?e=document.querySelector(t.container):t.container instanceof HTMLElement&&(e=t.container),!e)throw new Error("Container not found");this.parent=e;var[t,r]=this.initHtml();e.appendChild(t),this.container=t,this.scrollContainer=r.querySelector(".scroll"),this.wrapper=r.querySelector(".wrapper"),this.canvasWrapper=r.querySelector(".canvases"),this.progressWrapper=r.querySelector(".progress"),this.cursor=r.querySelector(".cursor"),this.initEvents()}initEvents(){this.wrapper.addEventListener("click",t=>{var e=this.wrapper.getBoundingClientRect(),t=(t.clientX-e.left)/e.width;this.emit("click",t)}),this.initDrag(),this.scrollContainer.addEventListener("scroll",()=>{var{scrollLeft:t,scrollWidth:e,clientWidth:r}=this.scrollContainer;this.emit("scroll",t/e,(t+r)/e)});const t=this.createDelay(100);this.resizeObserver=new ResizeObserver(()=>{t(()=>this.reRender())}),this.resizeObserver.observe(this.scrollContainer)}initDrag(){makeDraggable(this.wrapper,(t,e,r)=>{this.emit("drag",Math.max(0,Math.min(1,r/this.wrapper.clientWidth)))},()=>this.isDragging=!0,()=>this.isDragging=!1)}getHeight(){return null==this.options.height?128:isNaN(Number(this.options.height))?"auto"===this.options.height&&this.parent.clientHeight||128:Number(this.options.height)}initHtml(){var t=document.createElement("div"),e=t.attachShadow({mode:"open"});return e.innerHTML=`
      <style>
        :host {
          user-select: none;
        }
        :host .scroll {
          overflow-x: auto;
          overflow-y: hidden;
          width: 100%;
          position: relative;
          touch-action: none;
        }
        :host .noScrollbar {
          scrollbar-color: transparent;
          scrollbar-width: none;
        }
        :host .noScrollbar::-webkit-scrollbar {
          display: none;
          -webkit-appearance: none;
        }
        :host .wrapper {
          position: relative;
          overflow: visible;
          z-index: 2;
        }
        :host .canvases {
          min-height: ${this.getHeight()}px;
        }
        :host .canvases > div {
          position: relative;
        }
        :host canvas {
          display: block;
          position: absolute;
          top: 0;
          image-rendering: pixelated;
        }
        :host .progress {
          pointer-events: none;
          position: absolute;
          z-index: 2;
          top: 0;
          left: 0;
          width: 0;
          height: 100%;
          overflow: hidden;
        }
        :host .progress > div {
          position: relative;
        }
        :host .cursor {
          pointer-events: none;
          position: absolute;
          z-index: 5;
          top: 0;
          left: 0;
          height: 100%;
          border-radius: 2px;
        }
      </style>

      <div class="scroll" part="scroll">
        <div class="wrapper">
          <div class="canvases"></div>
          <div class="progress" part="progress"></div>
          <div class="cursor" part="cursor"></div>
        </div>
      </div>
    `,[t,e]}setOptions(t){this.options=t,this.reRender()}getWrapper(){return this.wrapper}getScroll(){return this.scrollContainer.scrollLeft}destroy(){var t;this.container.remove(),null!=(t=this.resizeObserver)&&t.disconnect()}createDelay(e=10){const r={};return this.timeouts.push(r),t=>{r.timeout&&clearTimeout(r.timeout),r.timeout=setTimeout(t,e)}}convertColorValues(t){if(!Array.isArray(t))return t||"";if(t.length<2)return t[0]||"";var e=document.createElement("canvas");const r=e.getContext("2d").createLinearGradient(0,0,0,e.height),i=1/(t.length-1);return t.forEach((t,e)=>{e*=i;r.addColorStop(e,t)}),r}renderBars(t,o,n){if(n.fillStyle=this.convertColorValues(o.waveColor),o.renderFunction)o.renderFunction(t,n);else{var a=t[0],l=t[1]||t[0],h=a.length,t=window.devicePixelRatio||1,{width:c,height:p}=n.canvas,d=p/2;const W=o.barHeight||1;var g=o.barWidth?o.barWidth*t:1,u=o.barGap?o.barGap*t:o.barWidth?g/2:0,v=o.barRadius||0,m=c/(g+u)/h;let e=1;if(o.normalize)for(let t=e=0;t<h;t++){var f=Math.abs(a[t]);f>e&&(e=f)}var b=d/e*W,C=v&&"roundRect"in n?"roundRect":"rect";n.beginPath();let r=0,i=0,s=0;for(let t=0;t<=h;t++){var w=Math.round(t*m);if(w>r){var y=Math.round(i*b);const W=y+Math.round(s*b)||1;let t=d-y;"top"===o.barAlign?t=0:"bottom"===o.barAlign&&(t=p-W),n[C](r*(g+u),t,g,W,v),r=w,i=0,s=0}y=Math.abs(a[t]||0),w=Math.abs(l[t]||0);y>i&&(i=y),w>s&&(s=w)}n.fill(),n.closePath()}}renderSingleCanvas(t,e,r,i,s,o,n,a){var l=window.devicePixelRatio||1,h=document.createElement("canvas"),c=t[0].length,i=(h.width=Math.round(r*(o-s)/c),h.height=i*l,h.style.width=Math.floor(h.width/l)+"px",h.style.height=i+"px",h.style.left=Math.floor(s*r/l/c)+"px",n.appendChild(h),h.getContext("2d")),r=(this.renderBars(t.map(t=>t.slice(s,o)),e,i),h.cloneNode()),l=(a.appendChild(r),r.getContext("2d"));0<h.width&&0<h.height&&l.drawImage(h,0,0),l.globalCompositeOperation="source-in",l.fillStyle=this.convertColorValues(e.progressColor),l.fillRect(0,0,h.width,h.height)}renderWaveform(r,i,s){const o=document.createElement("div"),n=this.getHeight(),a=(o.style.height=n+"px",this.canvasWrapper.style.minHeight=n+"px",this.canvasWrapper.appendChild(o),o.cloneNode());this.progressWrapper.appendChild(a);var{scrollLeft:t,scrollWidth:e,clientWidth:l}=this.scrollContainer;const h=r[0].length;e=h/e;let c=Math.min(Renderer.MAX_CANVAS_WIDTH,l);(i.barWidth||i.barGap)&&(l=(l=i.barWidth||.5)+(i.barGap||l/2),c%l!=0)&&(c=Math.floor(c/l)*l);l=Math.floor(Math.abs(t)*e),t=Math.floor(l+c*e);const p=t-l,d=(t,e)=>{this.renderSingleCanvas(r,i,s,n,Math.max(0,t),Math.min(e,h),o,a)},g=this.createDelay(),u=this.createDelay(),v=(t,e)=>{d(t,e),0<t&&g(()=>{v(t-p,e-p)})},m=(t,e)=>{d(t,e),e<h&&u(()=>{m(t+p,e+p)})};v(l,t),t<h&&m(t,t+p)}render(e){this.timeouts.forEach(t=>t.timeout&&clearTimeout(t.timeout)),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.wrapper.style.width="";var t=window.devicePixelRatio||1,r=this.scrollContainer.clientWidth,i=Math.ceil(e.duration*(this.options.minPxPerSec||0)),s=(this.isScrolling=r<i,this.options.fillParent&&!this.isScrolling),o=(s?r:i)*t;if(this.wrapper.style.width=s?"100%":i+"px",this.scrollContainer.style.overflowX=this.isScrolling?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=""+(this.options.cursorColor||this.options.progressColor),this.cursor.style.width=this.options.cursorWidth+"px",this.options.splitChannels)for(let t=0;t<e.numberOfChannels;t++){var n=Object.assign(Object.assign({},this.options),this.options.splitChannels[t]);this.renderWaveform([e.getChannelData(t)],n,o)}else{r=[e.getChannelData(0)];1<e.numberOfChannels&&r.push(e.getChannelData(1)),this.renderWaveform(r,this.options,o)}this.audioData=e,this.emit("render")}reRender(){var t,e;this.audioData&&(t=this.progressWrapper.clientWidth,this.render(this.audioData),e=this.progressWrapper.clientWidth,this.scrollContainer.scrollLeft+=e-t)}zoom(t){this.options.minPxPerSec=t,this.reRender()}scrollIntoView(t,e=!1){const{clientWidth:r,scrollLeft:i,scrollWidth:s}=this.scrollContainer;var t=s*t,o=r/2,e=e&&this.options.autoCenter&&!this.isDragging?o:r;(t>i+e||t<i)&&(this.options.autoCenter&&!this.isDragging?(e=o/20,t-(i+o)>=e&&t<i+r?this.scrollContainer.scrollLeft+=e:this.scrollContainer.scrollLeft=t-o):this.isDragging?this.scrollContainer.scrollLeft=t<i?t-10:t-r+10:this.scrollContainer.scrollLeft=t);{const i=this.scrollContainer["scrollLeft"];e=i/s,o=(i+r)/s;this.emit("scroll",e,o)}}renderProgress(t,e){isNaN(t)||(this.progressWrapper.style.width=100*t+"%",this.cursor.style.left=100*t+"%",this.cursor.style.marginLeft=100===Math.round(100*t)?`-${this.options.cursorWidth}px`:"",this.isScrolling&&this.options.autoScroll&&this.scrollIntoView(t,e))}}Renderer.MAX_CANVAS_WIDTH=4e3;export default Renderer;